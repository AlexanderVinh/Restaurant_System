{% extends "base.html" %}
{% block title %}Qu·∫£n l√Ω kho nguy√™n li·ªáu{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Qu·∫£n l√Ω kho nguy√™n li·ªáu</h2>
        <a href="{{ url_for('admin.add_inventory_item') }}" class="btn btn-primary">
            <i class="bi bi-plus-circle"></i> Th√™m nguy√™n li·ªáu
        </a>
    </div>

    <table class="table table-bordered table-hover table-striped align-middle">
        <thead class="table-dark text-center">
            <tr>
                <th>ID</th>
                <th>T√™n nguy√™n li·ªáu</th>
                <th>S·ªë l∆∞·ª£ng</th>
                <th>ƒê∆°n v·ªã</th>
                <th>Gi√° v·ªën</th>
                <th>Ng∆∞·ª°ng c·∫£nh b√°o</th>
                <th>H·∫°n s·ª≠ d·ª•ng</th>
                <th>Nh√† cung c·∫•p</th>
                <th>L·∫ßn c·∫≠p nh·∫≠t</th>
                <th>Tr·∫°ng th√°i</th>
                <th>Thao t√°c</th>
                <th>AI VSATTP</th>
            </tr>
        </thead>
        <tbody>
            {% for item in inventory %}
            <tr class="
                {% if item.is_expired() %}
                    table-danger
                {% elif item.is_near_expiry(3) %}
                    table-warning
                {% elif item.is_low_stock() %}
                    table-info
                {% endif %}
                ">
                <td class="text-center">{{ item.item_id }}</td>
                <td>{{ item.name }}</td>
                <td class="text-center">{{ item.quantity }}</td>
                <td class="text-center">{{ item.unit }}</td>
                <td class="text-end">{{ '{:,.0f}'.format(item.unit_cost or 0) }}ƒë/{{ item.unit }}</td>
                <td class="text-center">{{ item.threshold }}</td>

                <!-- H·∫°n s·ª≠ d·ª•ng -->
                <td class="text-center">
                    {% if item.expiry_date %}
                    {{ item.expiry_date.strftime('%d/%m/%Y') }}
                    {% else %}
                    <span class="text-muted">Kh√¥ng c√≥</span>
                    {% endif %}
                </td>

                <td>{{ item.supplier or '-' }}</td>
                <td class="text-center">
                    {{ item.last_updated.strftime('%d/%m/%Y %H:%M') }}
                </td>

                <!-- Tr·∫°ng th√°i -->
                <td class="text-center">
                    {% if item.is_expired() %}
                    <span class="badge bg-danger">
                        ‚ùå H·∫øt h·∫°n
                    </span>
                    {% elif item.is_near_expiry(3) %}
                    <span class="badge bg-warning text-dark">
                        ‚ö†Ô∏è S·∫Øp h·∫øt h·∫°n
                    </span>
                    {% elif item.is_low_stock() %}
                    <span class="badge bg-danger">
                        ‚ö†Ô∏è S·∫Øp h·∫øt h√†ng
                    </span>
                    {% else %}
                    <span class="badge bg-success">
                        ‚úÖ B√¨nh th∆∞·ªùng
                    </span>
                    {% endif %}
                </td>

                <!-- Thao t√°c -->
                <td class="text-nowrap text-center">
                    <a href="{{ url_for('admin.edit_inventory_item', item_id=item.item_id) }}"
                        class="btn btn-sm btn-warning">
                        <i class="bi bi-pencil"></i>
                    </a>

                    <form method="POST" action="{{ url_for('admin.delete_inventory_item', item_id=item.item_id) }}"
                        style="display:inline;"
                        onsubmit="return confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a nguy√™n li·ªáu n√†y kh√¥ng?');">
                        <button type="submit" class="btn btn-sm btn-danger">
                            <i class="bi bi-trash"></i>
                        </button>
                    </form>
                    <form method="POST" action="{{ url_for('admin.inspect_inventory', item_id=item.item_id) }}"
                        enctype="multipart/form-data" style="display:inline-block">

                        <label class="btn btn-sm btn-outline-info mb-1">
                            üì∑ Ch·ªçn ·∫£nh
                            <input type="file" name="image" accept="image/*" required hidden>
                        </label>

                        <button type="submit" class="btn btn-sm btn-info">
                            ü§ñ AI ki·ªÉm tra
                        </button>
                    </form>
                </td>
                <td class="text-center">
                    {% if item.ai_status %}
                    <span class="badge
                        {% if item.ai_status == 'safe' %}
                            bg-success
                        {% elif item.ai_status == 'warning' %}
                            bg-warning text-dark
                        {% else %}
                            bg-danger
                        {% endif %}" data-bs-toggle="tooltip" data-bs-placement="top" title="{{
                            item.inspections[0].ai_issues | replace(',', '&#10;')
                            if item.inspections and item.inspections[0].ai_issues
                            else 'Kh√¥ng ph√°t hi·ªán v·∫•n ƒë·ªÅ'
                        }}">
                        {% if item.ai_status == 'safe' %}üü¢ An to√†n{% endif %}
                        {% if item.ai_status == 'warning' %}üü° C·∫£nh b√°o{% endif %}
                        {% if item.ai_status == 'unsafe' %}üî¥ Kh√¥ng an to√†n{% endif %}
                    </span>
                    {% else %}
                    <span class="badge bg-secondary">Ch∆∞a ki·ªÉm tra</span>
                    {% endif %}
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="12" class="text-center">
                    Ch∆∞a c√≥ nguy√™n li·ªáu n√†o trong kho
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Ch√∫ th√≠ch -->
    <div class="mt-3">
        <span class="badge bg-danger">‚ùå H·∫øt h·∫°n</span>
        <span class="badge bg-warning text-dark">‚ö†Ô∏è S·∫Øp h·∫øt h·∫°n (‚â§ 3 ng√†y)</span>
        <span class="badge bg-danger">‚ö†Ô∏è S·∫Øp h·∫øt h√†ng</span>
        <span class="badge bg-success">‚úÖ B√¨nh th∆∞·ªùng</span>
    </div>
</div>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el => {
            new bootstrap.Tooltip(el)
        });
    });
</script>

{% endblock %}