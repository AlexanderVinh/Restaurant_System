{% extends "base.html" %}
{% block title %}B√°o c√°o & Th·ªëng k√™{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="fw-bold">üìä B√°o c√°o & Th·ªëng k√™</h2>
    </div>

    <!-- B·ªô l·ªçc th·ªùi gian -->
    <form method="get" class="row g-3 mb-4">
        <div class="col-md-4">
            <label for="start_date" class="form-label">T·ª´ ng√†y</label>
            <input type="date" id="start_date" name="start_date" class="form-control" value="{{ start_date }}">
        </div>
        <div class="col-md-4">
            <label for="end_date" class="form-label">ƒê·∫øn ng√†y</label>
            <input type="date" id="end_date" name="end_date" class="form-control" value="{{ end_date }}">
        </div>
        <div class="col-md-4 d-flex align-items-end">
            <button type="submit" class="btn btn-primary w-100">
                <i class="bi bi-filter"></i> L·ªçc b√°o c√°o
            </button>
        </div>
    </form>

    <!-- 1Ô∏è‚É£ Doanh thu theo ng√†y -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-primary text-white fw-bold">üìà Doanh thu theo ng√†y</div>
        <div class="card-body">
            {% if daily_revenue %}
            <canvas id="revenueChart" height="120"></canvas>
            {% else %}
            <p class="text-center text-muted mb-0">Ch∆∞a c√≥ d·ªØ li·ªáu trong kho·∫£ng th·ªùi gian n√†y.</p>
            {% endif %}
        </div>
    </div>

    <!-- 2Ô∏è‚É£ M√≥n b√°n ch·∫°y -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-success text-white fw-bold">üçΩÔ∏è Top 10 m√≥n b√°n ch·∫°y</div>
        <div class="card-body">
            {% if top_dishes %}
            <table class="table table-striped table-bordered text-center align-middle">
                <thead class="table-dark">
                    <tr>
                        <th>#</th>
                        <th>T√™n m√≥n</th>
                        <th>S·ªë l∆∞·ª£ng b√°n</th>
                        <th>Doanh thu</th>
                    </tr>
                </thead>
                <tbody>
                    {% for dish in top_dishes %}
                    <tr>
                        <td>{{ loop.index }}</td>
                        <td>{{ dish.name }}</td>
                        <td>{{ dish.total_sold }}</td>
                        <td>{{ "{:,.0f}".format(dish.revenue) }}‚Ç´</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p class="text-center text-muted mb-0">Kh√¥ng c√≥ d·ªØ li·ªáu m√≥n ƒÉn trong giai ƒëo·∫°n n√†y.</p>
            {% endif %}
        </div>
    </div>

    <!-- 3Ô∏è‚É£ Th·ªëng k√™ theo lo·∫°i ƒë∆°n -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-info text-white fw-bold">üßæ Th·ªëng k√™ theo lo·∫°i ƒë∆°n h√†ng</div>
        <div class="card-body">
            {% if order_types %}
            <canvas id="orderTypeChart" height="120"></canvas>
            {% else %}
            <p class="text-center text-muted mb-0">Kh√¥ng c√≥ d·ªØ li·ªáu ƒë∆°n h√†ng.</p>
            {% endif %}
        </div>
    </div>

    <!-- 4Ô∏è‚É£ Top kh√°ch h√†ng -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-warning text-dark fw-bold">üë• Top kh√°ch h√†ng chi ti√™u nhi·ªÅu nh·∫•t</div>
        <div class="card-body">
            {% if top_customers %}
            <table class="table table-striped table-bordered text-center align-middle">
                <thead class="table-dark">
                    <tr>
                        <th>#</th>
                        <th>T√™n kh√°ch h√†ng</th>
                        <th>Email</th>
                        <th>S·ªë ƒë∆°n</th>
                        <th>T·ªïng chi ti√™u</th>
                    </tr>
                </thead>
                <tbody>
                    {% for customer in top_customers %}
                    <tr>
                        <td>{{ loop.index }}</td>
                        <td>{{ customer.name }}</td>
                        <td>{{ customer.email }}</td>
                        <td>{{ customer.order_count }}</td>
                        <td>{{ "{:,.0f}".format(customer.total_spent) }}‚Ç´</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p class="text-center text-muted mb-0">Kh√¥ng c√≥ d·ªØ li·ªáu kh√°ch h√†ng trong giai ƒëo·∫°n n√†y.</p>
            {% endif %}
        </div>
    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    /* ========= BI·ªÇU ƒê·ªí DOANH THU THEO NG√ÄY ========= */
    {% if daily_revenue %}
    const revenueCtx = document.getElementById('revenueChart').getContext('2d');

    new Chart(revenueCtx, {
        type: 'line',
        data: {
            labels: [
                {% for d in daily_revenue %}
                '{{ d.date }}',
            {% endfor %}
        ],
        datasets: [{
            label: 'Doanh thu (‚Ç´)',
            data: [
                {% for d in daily_revenue %}
                    {{ d.revenue }},
        {% endfor %}
    ],
        borderColor: 'rgba(54, 162, 235, 1)',
        backgroundColor: 'rgba(54, 162, 235, 0.2)',
        tension: 0.3,
        fill: true,
        borderWidth: 2,
        pointRadius: 4
        }]
    },
        options: {
        responsive: true,
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    callback: value => value.toLocaleString() + ' ‚Ç´'
                }
            }
        }
    }
});
    {% endif %}

    /* ========= BI·ªÇU ƒê·ªí LO·∫†I ƒê∆†N ========= */
    {% if order_types %}
    const orderTypeCtx = document.getElementById('orderTypeChart').getContext('2d');

    new Chart(orderTypeCtx, {
        type: 'doughnut',
        data: {
            labels: [
                {% for o in order_types %}
                '{{ o.order_type }}',
            {% endfor %}
        ],
        datasets: [{
            data: [
                {% for o in order_types %}
                    {{ o.count }},
        {% endfor %}
    ],
        backgroundColor: [
        '#36A2EB',
        '#FF6384',
        '#FFCE56',
        '#4BC0C0'
    ]
        }]
    },
        options: {
        responsive: true,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});
    {% endif %}
</script>

{% endblock %}