{% extends "base.html" %}

{% block title %}Tr·ª£ L√Ω AI - {{ restaurant_name }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/chatbot.css') }}">
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="chat-container">
        <div class="chat-header">
            <h2><i class="bi bi-robot"></i> Tr·ª£ L√Ω AI</h2>
            <p>Xin ch√†o! T√¥i c√≥ th·ªÉ gi√∫p g√¨ cho b·∫°n h√¥m nay? üòä</p>
        </div>

        <div class="chat-messages" id="chatMessages">
            <div class="welcome-message">
                <i class="bi bi-chat-heart"></i>
                <h4>Ch√†o m·ª´ng b·∫°n ƒë·∫øn v·ªõi Tr·ª£ l√Ω AI!</h4>
                <p>T√¥i c√≥ th·ªÉ gi√∫p b·∫°n:</p>
                <ul style="list-style: none; padding: 0; margin-top: 15px;">
                    <li>üçΩÔ∏è G·ª£i √Ω m√≥n ƒÉn best seller</li>
                    <li>üìÖ H·ªó tr·ª£ ƒë·∫∑t b√†n</li>
                    <li>üí∞ T∆∞ v·∫•n gi√° c·∫£, menu</li>
                    <li>ü•ó T∆∞ v·∫•n calories ‚Äì ƒÉn ki√™ng</li>
                    <li>‚è∞ Th√¥ng tin gi·ªù m·ªü c·ª≠a</li>
                </ul>
                <p style="margin-top: 20px; color: #667eea; font-weight: 500;">
                    H√£y ch·ªçn m·ªôt c√¢u h·ªèi g·ª£i √Ω b√™n d∆∞·ªõi ho·∫∑c nh·∫≠p c√¢u h·ªèi c·ªßa b·∫°n!
                </p>
            </div>
        </div>

        <div class="chat-input-area">
            <div class="suggestions" id="suggestions"></div>

            <div class="input-group">
                <input type="text" id="messageInput" placeholder="Nh·∫≠p c√¢u h·ªèi c·ªßa b·∫°n..." autocomplete="off">
                <button id="sendButton" title="G·ª≠i tin nh·∫Øn">
                    <i class="bi bi-send-fill" style="font-size: 20px;"></i>
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let chatHistory = [];

    // Load suggestions khi trang load
    $(document).ready(function () {
        loadSuggestions();
        $('#messageInput').focus();
    });

    // =======================
    // Load g·ª£i √Ω c√¢u h·ªèi
    // =======================
    function loadSuggestions() {
        $.get('/chatbot/api/quick-questions', function (data) {
            const suggestionsHtml = data.suggestions.map(s =>
                `<div class="suggestion-chip" onclick="sendMessage('${s}')">${s}</div>`
            ).join('');
            $('#suggestions').html(suggestionsHtml);
        });
    }

    // =======================
    // Enter ƒë·ªÉ g·ª≠i
    // =======================
    $('#messageInput').on('keypress', function (e) {
        if (e.which === 13 && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });

    // Click button g·ª≠i
    $('#sendButton').on('click', function () {
        sendMessage();
    });

    // =======================
    // G·ª≠i tin nh·∫Øn
    // =======================
    function sendMessage(presetMessage = null) {
        const message = presetMessage || $('#messageInput').val().trim();
        if (!message) return;

        $('#messageInput').val('');
        $('.welcome-message').remove();

        appendMessage('user', message);

        showTypingIndicator();
        $('#messageInput, #sendButton').prop('disabled', true);

        $.ajax({
            url: '/chatbot/api/chat',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                message: message,
                history: chatHistory
            }),
            success: function (response) {
                hideTypingIndicator();

                if (response.success) {
                    appendMessage(
                        'bot',
                        response.message,
                        response.timestamp,
                        response.image || null
                    );

                    chatHistory.push({ role: 'user', content: message });
                    chatHistory.push({ role: 'assistant', content: response.message });

                    if (chatHistory.length > 20) {
                        chatHistory = chatHistory.slice(-20);
                    }
                } else {
                    appendMessage('bot', response.message || 'C√≥ l·ªói x·∫£y ra');
                }
            },
            error: function () {
                hideTypingIndicator();
                appendMessage('bot', 'Xin l·ªói, chatbot ƒëang b·∫≠n üòî');
            },
            complete: function () {
                $('#messageInput, #sendButton').prop('disabled', false);
                $('#messageInput').focus();
            }
        });
    }

    // =======================
    // Render message (C√ì ·∫¢NH)
    // =======================
    function appendMessage(type, content, time = null, imageUrl = null) {
        const timestamp = time || new Date().toLocaleTimeString(
            'vi-VN',
            { hour: '2-digit', minute: '2-digit' }
        );

        const avatar = type === 'bot' ? 'ü§ñ' : 'üë§';

        let imageHtml = '';
        if (imageUrl) {
            imageHtml = `
            <div class="message-image">
                <img src="${imageUrl}" alt="M√≥n ƒÉn" loading="lazy">
            </div>
        `;
        }

        const messageHtml = `
        <div class="message ${type}">
            <div class="message-avatar">${avatar}</div>
            <div class="message-body">
                <div class="message-content">${content}</div>
                ${imageHtml}
                <div class="message-time">${timestamp}</div>
            </div>
        </div>
    `;

        $('#chatMessages').append(messageHtml);
        scrollToBottom();
    }

    // =======================
    // Typing indicator
    // =======================
    function showTypingIndicator() {
        const typingHtml = `
        <div class="message bot" id="typingIndicator">
            <div class="message-avatar">ü§ñ</div>
            <div class="typing-indicator show">
                <span></span><span></span><span></span>
            </div>
        </div>
    `;
        $('#chatMessages').append(typingHtml);
        scrollToBottom();
    }

    function hideTypingIndicator() {
        $('#typingIndicator').remove();
    }

    // =======================
    // Scroll
    // =======================
    function scrollToBottom() {
        const chatMessages = document.getElementById('chatMessages');
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
</script>
{% endblock %}